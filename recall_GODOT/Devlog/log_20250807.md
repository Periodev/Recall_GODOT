# ğŸ“¦ Recall V0.4 - ç¬¬ä¸€éšæ®µå®Œæˆç¸½çµï¼ˆ2025-08-06ï¼‰

## ğŸ“ å°ˆæ¡ˆåˆå§‹åŒ–
- âœ… æˆåŠŸå»ºç«‹ `Godot 4.4.1 + Mono` C# å°ˆæ¡ˆ
- âœ… ç¢ºç«‹ä¸»çµæ§‹ç›®éŒ„èˆ‡ `Script/` è³‡æ–™å¤¾å‘½åè¦ç¯„
- âœ… Combat æ¨¡çµ„æ¡ç”¨ `Control` ä½œç‚ºä¸»å…¥å£
- âœ… æ‰€æœ‰ `.csproj`, `.godot` çµ„æ…‹ç„¡èª¤ï¼ŒæˆåŠŸåŸ·è¡Œ

---

## ğŸ§± æ ¸å¿ƒæ¨¡çµ„å®Œæˆ

### ğŸ”· `CombatState.cs`
- ç¹¼æ‰¿è‡ª Godot `Node`ï¼Œç‚ºæˆ°é¬¥ç‹€æ…‹å®¹å™¨
- æŒæœ‰ `PhaseContext` ä»£è¡¨ç›®å‰ phase ç‹€æ…‹
- å¯¦ä½œ `_Ready()` å®Œæˆåˆå§‹åŒ–

### ğŸ”· `PhaseContext.cs`
- å®šç¾© `PhaseStep` æšèˆ‰ + `TurnNum`
- ç‚º struct å‹åˆ¥ï¼Œæ”¯æ´ `ref` å‚³é
- å¯å®‰å…¨è¢«æ ¸å¿ƒ kernel æ¨é€²èˆ‡è®€å¯«

### ğŸ”· `PhaseStep.cs`
- å®šç¾©å®Œæ•´éšæ®µæšèˆ‰ï¼š
  - `TurnStart`, `EnemyInit`, `EnemyIntent`, ...
  - `PlayerInput`, `PlayerExecute`, `TurnEnd`, `CombatEnd`

---

## âš™ï¸ æ ¸å¿ƒé‚è¼¯ï¼š`CombatKernel.cs`
- `Run(ref PhaseContext)`ï¼šå–®æ­¥æ¨é€² phase
- `AdvanceUntilInput(ref ...)`ï¼šé€£çºŒæ¨é€²è‡³éœ€è¦è¼¸å…¥
- åŒæ™‚æ”¯æ´ `ref CombatState` / `ref PhaseContext` å‘¼å«
- åŠ å…¥ debug log è¼¸å‡ºï¼ˆ`GD.Print()`ï¼‰

---

## ğŸ”„ Phase é©…å‹•æ¶æ§‹

### âœ… `PhaseMap.cs`
- ä½¿ç”¨ Dictionary å°æ‡‰ `PhaseStep` â†’ å°æ‡‰çš„ StepFunc

### âœ… `EnemyPhase.cs` / `PlayerPhase.cs`
- å®šç¾©æ¯å€‹ PhaseStep çš„åŸ·è¡Œé‚è¼¯
- å°‡æ§åˆ¶æµæ¸…æ¥šåˆ‡åˆ†ç‚ºæ•µæˆ‘å…©æ–¹

### âœ… `PhaseResult.cs`
- æšèˆ‰å‹æ…‹ï¼Œå®šç¾©æ­¥é©Ÿçµæœç‹€æ…‹ï¼š
  - `Continue`
  - `WaitInput`
  - `Pending`
  - `Interrupt`

---

## ğŸ”Œ Godot æ•´åˆï¼š`Combat.cs`
- ç¹¼æ‰¿ `Control`ï¼Œä½œç‚ºä¸»æ§åˆ¶å…¥å£
- `[Export] public CombatState CombatState;` æˆåŠŸé€£çµ Node
- `Ready()` ä¸­å‘¼å« `AdvanceUntilInput(ref CombatState.PhaseCtx)`
- æˆåŠŸåŸ·è¡Œä¸¦åœåœ¨ `WaitInput`

---

## âœ… æ¸¬è©¦æµç¨‹ Log

```text
Combat is ready
read CombatState success
Continue to next step EnemyInit
Continue to next step EnemyIntent
Continue to next step EnemyExecInstant
Continue to next step PlayerInit
Continue to next step PlayerDraw
Continue to next step PlayerInput
Wait Input
Combat state is ready
