V0.5.x · Intent Queue & Delayed Flow Stabilization

TL;DR

✅ PlayerIntentQueue：玩家行為統一進佇列，由 PlayerExecute 一次清空。

✅ EnemyDelayedQueue：敵方延遲（目前 A）改為在 End Turn 後於 EnemyExecDelayed 執行。

✅ 敵人不使用 AP：AP 規則只對玩家生效（移除敵方 NoAP 問題）。

✅ 時機策略：A → Delayed、B/C → Instant；無 Instant 時直接交還玩家。

✅ 查找介面更新：改用 TryGetActorById(int id, out Actor actor) 委派貫穿 Translator／Pipeline。

變更摘要
1) 佇列化

PlayerIntentQueue

所有玩家 Basic / Recall 先 enqueue，在 PlayerExecute 批次翻譯→執行。

AP 攤提與扣款改由批次執行統一處理，避免逐條通過但總量不足的邊緣情況。

EnemyDelayedQueue

敵方 A 攻擊按策略排入「延遲佇列」（本回合到期或跨回合）。

TryEndPlayerTurn 檢查到期項，轉入 EnemyExecDelayed 逐筆執行；否則直接 TurnEnd。

2) AP 規則（玩家專屬）

敵人不持有／不消耗 AP；只對玩家做 AP 成本檢查與 ConsumeAP 指令產生。

建指令時僅在 APCost > 0 才加入 ConsumeAP，降低日誌噪音。

3) Phase 映射調整

EnemyIntent：只在本回合產生一次意圖並入列。

若有 Instant → EnemyExecInstant

若無 Instant → PlayerInit（交還玩家）

EnemyExecInstant：清空後固定 → PlayerInit

TryEndPlayerTurn：有 due 的 Delayed → EnemyExecDelayed；否則 TurnEnd

EnemyExecDelayed：只消費「本回合到期」，執行完固定 → TurnEnd

4) Translator/介面

使用委派 TryGetActorById 取目標與識別玩家，讓「是否吃 AP」在 Translator 端可判斷而不綁定具體型別。

驗收與觀察

🟢 B → EndTurn → A(Delayed,0)：同回合盾先到位，延遲 A 正確被盾吸收，日誌顯示 shield absorbed N, HP damage M。

🟢 僅 A（Delayed）：EnemyIntent → PlayerInit/Draw/Input → … → EndTurn → EnemyExecDelayed(A) → TurnEnd，不再在 EnemyIntent ↔ EnemyExecInstant 間打轉。

🟢 NoAP 移除：延遲攻擊不再因 AP 判斷被丟棄。

🟡 日誌：若傷害全被格擋，可能只看到「吸收 N」，建議永久印出 HP damage 0（已列在 TODO）。

修復的問題

🔧 敵人 AP 導致延遲攻擊失效：敵方指令不再產生 ConsumeAP；NoAP 不會再中斷延遲攻擊。

🔧 PhaseRunner 迭代 timeout：修正 EnemyExecInstant 空佇列時誤回 EnemyIntent 的路徑；現在改為交還 PlayerInit。

待辦 / 風險

 Delayed 到期語意固定：
選擇 相對回合（due-- 消費 0） 或 絕對回合（dueAtTurn==currentTurn），統一全域使用。

 EnemyIntent 單次產生：以旗標保證同回合不重入，回合起點重置。

 Damage 日誌一致性：0 傷也印 DealDamage ... HP damage 0，提升可觀測性。

 整合測試：新增三條 E2E 驗證

Only A(Delayed,0)

B(Instant)+A(Delayed,0)

A(Delayed,1)（跨回合）

 UI 細節：當 HasPendingIntent 或有到期 Delayed 未處理時，End Turn 按鈕狀態與提示一致。