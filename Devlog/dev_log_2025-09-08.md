# ğŸ› ï¸ Dev Log â€” 2025-09-08

> ä¸»é¡Œï¼šEchoã€ŒæŸ¥è¡¨åŒ–ã€è½åœ°ã€EchoStore å…§é…è™Ÿã€Recall æµç¨‹ç°¡åŒ–ç‚º `RecipeId` å–®ä¸€ä¾†æºã€‚  
> ç‹€æ…‹ï¼šå·²åˆä½µã€è·‘é€šã€‚Godot 4.4.1 å¯¦æ¸¬é€šéã€‚

---

## âœ… ä»Šæ—¥å®Œæˆ

### 1) Echo å»ºæ§‹æ”¹ç‚ºã€Œç´”æŸ¥è¡¨ã€
- æ–°å¢/æ•´ä½µï¼š`EchoFactory.BuildFromRecipe(int recipeId)`ï¼ˆEcho åˆå§‹ `Id=0` å ä½ï¼‰ã€‚
- Echo å…§å«**åŸ·è¡Œæ¬„ä½**ï¼ˆ`Op/TargetType/CostAP`ï¼‰èˆ‡**å±•ç¤ºæ¬„ä½**ï¼ˆ`Name/Label/Summary`ï¼‰ï¼ŒUI å…å†æŸ¥è¡¨ã€‚
- ç§»é™¤ `turn/runSeed` åƒæ•¸ä¾è³´ï¼›å»ºæ§‹å®Œå…¨ç”± `RecipeRegistry` æ±ºå®šã€‚  
**æª”æ¡ˆ**ï¼š`Core/Recall/EchoFactory.cs`ã€`Core/Recall/Echo.cs`

### 2) EchoStore å…§é…è™Ÿï¼ˆéå¢ã€ä¸å›æ”¶ï¼‰
- `TryAdd(Echo e)`ï¼šè‹¥ `e.Id == 0` â†’ æŒ‡æ´¾ `_nextId++`ï¼›è‹¥å¤–éƒ¨å¸¶å…¥éé›¶ä¸”æ’è™Ÿ â†’ è¿´é¿é‡é…ã€‚  
- `TryRemove(Echo)`ï¼šä»¥ **Id** æ¯”å°ç§»é™¤ï¼Œé¿å…æ§½ä½æ¼‚ç§»é€ æˆåˆªéŒ¯ã€‚  
- ç›®çš„ï¼šå ´å…§å”¯ä¸€ã€èˆ‡ UI å‹•ç•«å®‰å…¨å°ä½ã€æ¸›å°‘å‘¼å«ç«¯åƒæ•¸ã€‚  
**æª”æ¡ˆ**ï¼š`Core/Recall/EchoStore.cs`

### 3) Recall ç®¡ç·šåˆ‡åˆ° RecipeId
- `RecallPlan`ï¼š`ActionSequence` â†’ **`RecipeId`**ï¼ˆåƒ…å¸¶é…æ–¹ ID èˆ‡ APCostï¼‰ã€‚
- `CombatPipeline`ï¼ˆCommitï¼‰ï¼š`RecipeId â†’ BuildFromRecipe â†’ echoStore.TryAdd`ï¼›æˆåŠŸæ‰ `MarkRecallUsed()`ï¼›**ä¸å¯«å…¥ Memory**ã€‚
- `EchoIntent`ï¼šç§»é™¤ `SlotIndex`ï¼Œä»¥ `Echo.Id` åšè­˜åˆ¥ã€‚  
**æª”æ¡ˆ**ï¼š`Core/InterOp/InterOps.cs`ã€`Core/InterOp/Translator.cs`ã€`Core/Kernel/CombatPipeline.cs`

### 4) RecipeRegistry ä¸Šç·šï¼ˆæœ€å°é›†ï¼‰
- æä¾›ï¼š`TryGetRecipe/GetRecipe/ContainsRecipe`ã€‚
- å…§å»ºæ¨£ä¾‹ï¼š`Attack(1)/Block(2)/Charge(3)/â€¦`ï¼Œå« `Op/TargetType/CostAP/Name/Label/Summary`ã€‚  
**æª”æ¡ˆ**ï¼š`Core/Recall/RecipeRegistry.cs`

### 5) UI / Debug å°é½Š
- Debug å…©å¼µ Echoï¼ˆAttack/Blockï¼‰ä»¥ `Id=0` å»ºç«‹ï¼Œå…¥åº«æ™‚è‡ªå‹•é…è™Ÿã€‚
- EchoPanel/RecallPanel log é¡¯ç¤º `slot` èˆ‡ **é…è™Ÿå¾Œçš„ `Id`**ï¼Œé©—è­‰ã€ŒåŒæ§½ä¸åŒ Echo â†’ ä¸åŒ Idã€ã€‚

---

## ğŸ§ª å¯¦æ©Ÿé©—è­‰é‡é»ï¼ˆç¯€éŒ„ï¼‰
- åŒä¸€æ§½ä½å…ˆå¾Œæ”¾å…¥ `Block (ID 2)`ã€`Attack (ID 3)` â†’ **ID ä¸é‡ç”¨**ã€‚
- Recall åªè¨˜ `RecipeId`ï¼š`Player recalled RecipeId[1]` â†’ Commit æˆåŠŸå¾Œæ‰è¦‹åˆ°æ–° Echoï¼ˆID æŒ‡æ´¾å®Œæˆï¼‰ã€‚  
- æ’­æ”¾ Echoï¼šæ‰£ 1 APã€é€ æˆæ­£ç¢ºæ•ˆæœï¼›ç§»é™¤ä»¥ `Id` ç²¾æº–ï¼ŒUI æ›´æ–°æ­£å¸¸ã€‚

---

## ğŸ“¦ Diff çµ±è¨ˆï¼ˆ0908ï¼‰
- 9 files changed, 144 insertions(+), 71 deletions(-)

**ä¸»è¦æª”æ¡ˆ**
- `Combat.cs`ï¼ˆdebug ç”Ÿæˆ Echo ä¹‹ Id=0 å ä½ï¼‰
- `Core/InterOp/InterOps.cs`ï¼ˆRecallPlan æ”¹ç‚º RecipeIdï¼‰
- `Core/InterOp/Translator.cs`ï¼ˆæ–°å¢ `ContainsRecipe` é©—è­‰èˆ‡æ—¥èªŒï¼‰
- `Core/Kernel/CombatPipeline.cs`ï¼ˆCommitï¼šBuildFromRecipe â†’ TryAddï¼‰
- `Core/Recall/Echo.cs`ï¼ˆEcho çµæ§‹èˆ‡å±¬æ€§èª¿æ•´ï¼‰
- `Core/Recall/EchoStore.cs`ï¼ˆå…§é…è™Ÿ `_nextId` èˆ‡é‡é…ä¿éšªï¼‰
- `Core/Recall/RecipeRegistry.cs`ï¼ˆæ–°ï¼‰
- `Core/UI/RecallQuery.cs`ã€`UIScript/EchoPanel.cs`ï¼ˆUI å°é½Šï¼‰

---

## ğŸ¯ å½±éŸ¿èˆ‡ç†ç”±
- **å¯é æ€§**ï¼šä»¥ `Id` ç‚ºå”¯ä¸€éŒ¨ï¼Œæ¶ˆé™¤ UI/æ ¸å¿ƒç´¢å¼•æ¼‚ç§»é¢¨éšªã€‚
- **å¯ç¶­è­·æ€§**ï¼šEcho è¡Œç‚ºç”±è³‡æ–™è¡¨é©…å‹•ï¼ˆRecipeRegistryï¼‰ï¼Œæ¸¬è©¦æ›´èšç„¦ã€‚
- **ç°¡åŒ–å‘¼å«ç«¯**ï¼šRecall åƒ…å‚³ `RecipeId`ï¼›Factory/Store å„å¸å…¶è·ã€‚

---

## ğŸ” å¾…è¾¦ï¼ˆè¼•é‡ï¼‰
- Combat é–‹å§‹æ™‚é‡ç½® `_nextId`ï¼›å¦‚æœ‰è¼‰å…¥/å­˜æª”å°‡ `_nextId` ä¸€ä½µæŒä¹…åŒ–ã€‚
- `ResolveRecipeId(pattern, config)`ï¼šæ›¿æ› `RecallQuery` çš„æš«å®š `recipeId=1`ã€‚
- å–®æ¸¬æœ€å°é›†ï¼š
  - `BuildFromRecipe_IdZero_UntilStored`
  - `EchoStore_TryAdd_AssignsIncrementalId_Unique`
  - `EchoStore_TryAdd_ReassignsOnCollision_ForNonZeroId`
  - `Pipeline_Recall_AddsEcho_And_MarksUsed`

---

## ğŸ—’ï¸ å‚™å¿˜
- Debug Replay **ä¸éœ€è¦**é‚„åŸ Echo.Idï¼›åªè¦è¨˜éŒ„ `RecipeId`ï¼ˆèˆ‡æ’­æ”¾ç•¶ä¸‹çš„ `slotIndex` æˆ– `(recipeId, nth)`ï¼‰å³å¯é‡ç¾ã€‚

