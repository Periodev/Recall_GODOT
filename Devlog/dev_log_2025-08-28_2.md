# Recall — 進度統整（2025-08-29）
**主題：Recall 最小化實作（扣 1 AP＋顯示訊息），暫不產生 Echo**

---

## 🎯 本次目標
- 將 `Recall` 行為簡化為：**僅消耗 1 AP**，並輸出 `Player recalled [..]` 訊息。
- 不寫入記憶、**不**產生 Echo token、**不**新增其他命令。
- 調整 `RecallIntent` 移除 `TargetId`（現階段 Recall 不需要目標）。

---

## ✅ 已完成變更
### 介面與資料
- **`RecallIntent`**
  - 移除 `TargetId` 參數：`public sealed record RecallIntent(int[] RecallIndices) : Intent((int?)null);`
- **`RecallPlan`**
  - 瘦身為最小資料：`Source : Actor`、`ActionSequence : ActionType[]`、`APCost : int`（預設 1）。
  - 移除 `Items`、`BatchChargeCost` 等欄位。

### 執行管線
- **`Translator.TryRecall`**
  - 僅保留「索引驗證（不可越界/不可含本回合）」＋「AP 檢查（≥1）」。
  - 由索引建立 `ActionSequence` → 建立最小 `RecallPlan`。
  - 不再解析/要求目標。
- **`InterOps.BuildRecall`**
  - 僅回傳 `AtomicCmd.ConsumeAP(plan.Source, plan.APCost)`。
  - 同時 `Debug.WriteLine($"Player recalled [{pattern}]");`（`pattern` 為 `ActionSequence` 無逗號串接，如 `CA`）。
- **`CombatPipeline.CommitPlayerAction`**
  - 加入 **成功守門**：`if (!execResult.Success) return;`
  - 僅在成功時：
    - `BasicIntent` → 將 `Act` 寫入記憶。
    - `RecallIntent` → `MarkRecallUsed()`（一回合一次）。

### 刪除/移除
- 刪除 `RecallItemPlan` 型別。
- 移除 `RecallPlan.Items`、`RecallPlan.BatchChargeCost`。
- 移除 `BuildRecall` 內的批次 `foreach` 扣費/計算邏輯。

---

## 🗂 影響檔案
- `Script/Combat.cs`（更新 UI 呼叫：`new RecallIntent(indices)`）
- `Script/InterOp/InterOps.cs`（`RecallPlan` 瘦身；`BuildRecall` 改為 AP-only＋Log）
- `Script/InterOp/Translator.cs`（簡化 `TryRecall`；移除目標與批次邏輯）
- `Script/Kernel/CombatPipeline.cs`（提交護欄：僅成功才提交副作用）

---

## 🧪 行為驗收
- 合法 Recall：AP −1；輸出 `Player recalled [CA]`；**記憶軸不變**；回到 `PlayerInput`。
- 同回合第二次 Recall：被 Translator/旗標擋下（相應 `FailCode`）；不扣 AP、不輸出訊息。
- AP 不足 / 索引非法（含本回合）：回對應 `FailCode`；不扣 AP、不輸出訊息。

> 範例執行輸出（節錄）  
> ```
> [Combat] OnRecallConfirm: [1, 2]
> [PhaseRunner] Accepting player action: RecallIntent { ... }
> [Queue] Dequeued: Player: RecallIntent { ... }
> Player recalled [BA]
> [ConsumeAP] Player consumed 1 AP
> [Combat] Recall result: WaitInput, Step: PlayerInput
> ```

---

## 🧹 後續建議（可選）
- 將 `Recall` AP 成本改為中央常數（例如 `GameConst.RECALL_AP_COST = 1`），整體收斂。
- 視需求將 `Debug.WriteLine` 改為 UI 事件（例如 `UISignalHub.NotifyText(...)`），以便遊戲內顯示。
- **下一步**：在既有鉤點（`BuildRecall` 或 Translator 成功分支）替換訊息為「生成 Echo token → 放入技能槽」。

---

## 📦 分支 / 提交（建議訊息）
- 分支（建議）：`feat/recall-minimal-hook`
- Commit message：
  - `refactor(recall): minimal hook (consume 1 AP + log); remove RecallItemPlan/batch`
  - 說明：`Simplify Recall to AP-only + log; remove target from RecallIntent; translator & interops trimmed; commit only on success.`

---

## 🔎 快速稽核指令
```bash
# 找舊簽名呼叫（應只剩 new RecallIntent(indices)）
rg --line-number "new\s+RecallIntent\s*\(" -n

# 確認刪除型別/欄位已移除
rg -n "RecallItemPlan|BatchChargeCost|Items\s*\)"
```

---

## 風險評估
- **低**：本次改動僅限 Recall 相關最小路徑；不影響 Basic 動作數值與敵人佇列。
- 守門改為 `execResult.Success` 可避免未來加入 Reaction/Echo 時的非預期副作用提交。
