# Dev Log — 2025-09-09

> Branch/Scope: Core + Godot UI  
> Commit: `7dd55526`（Recipe 選擇 UI 串接 / Issue #15 最小實作）

---

## 🎯 今日重點（Done）
- **Recipe 選擇流程打通（Issue #15）**
  - 新增極薄 **RecipeSystem**：提供以 `patternKey:int` 全掃描 `RecipeRegistry` 的查詢（不含 unlock/gating/cooldown）。
  - **PatternExtractor**：採直觀十進位鍵（AB-only, 1–3L），產出 pattern key 與 label（如 `A+B`）。
  - **UI（RecallPanel）**：
    - `Check`：由 Timeline 選擇 → `patternKey` → RecipeSystem 全掃描 → **ItemList** 列出候選，並在**預覽卡槽**顯示名稱/標籤/摘要。
    - **預設選擇**：若存在 `expectedId = patternKey * 10 + 1`（例如 `AA(11)→111`），則優先；否則取第一筆（`recipeId` 升冪）。
    - `Confirm`：送出 `RecallIntent`（以 **選中 recipeId** 為準）。
- **RecipeRegistry 樣本補齊（2L Echo）**
  - `AA → 111/112`、`AB → 121`、`BA → 211/212`、`BB → 221`（含名稱、標籤、摘要）。
- **流程驗證**
  - 實機 log 顯示：Check 能找到 2 筆候選（如 `AA`→`111/112`、`BA`→`211/212`），多次切換後 **Confirm 正確送出選中 id（如 112）**，核心接受並回傳成功。

---

## 📜 代表性執行紀錄（節錄）
[RecallPanel] Check pressed with selection: [0, 1]
[RecallPanel] Found 2 candidate recipes
[RecallPanel] Selected Recipe: 112
[RecallPanel] Confirm with selected recipeId: 112
[Combat] OnRecallConfirm: recipeId=112
[PhaseRunner] Accepting player action: RecallIntent { ... RecipeId = 112 }
[Dequeued]: Player: RecallIntent { ... RecipeId = 112 }
Player recalled RecipeId[112]
[Combat] Recall result: WaitInput, Step: PlayerInput



---

## 🧩 規格/決策更新
- **PatternKey**：AB-only 十進位（`A=1, B=2`），長度 1–3；C 暫不處理（已預留未來擴充）。
- **預設候選規則**：`expectedId = patternKey * 10 + 1`；若不存在則選最小 `recipeId`。
- **本階段不納入**：unlock/gating/cooldown（之後以 Provider 介面擴充）。

---

## 🐞 既知事項 / 風險
- **全掃描效能**：目前每次 Check 才掃 Registry，量大後需以 `label → ids[]` 建索引。
- **UI 壓測**：手動連點無問題，但仍建議後續加入（可選）防抖/單發保護。
- **一致性**：請維持候選排序以 `recipeId` 升冪，確保預設選擇穩定。

---

## ✅ 待辦（明日優先）
1. **建索引（Init 時）**：`IndexByLabel: "A+B" → int[] recipeIds`，替代每次全掃描。
2. **單元測試（最小）**
   - `PatternExtractor`：`[A,B]→12`、`[B,A]→21`、忽略 C、長度邊界。
   - `RecipeSystem.GetRecipesByPattern`：正確比對 label、排序、無匹配返回空。
3. **UI 穩定化（可選）**：Check 防抖（80ms）、Confirm 單發、同 key 不重算。

---

## 📦 變更摘要
- 新：`RecipeSystem`（薄層，pattern→全掃描→候選）
- 新/改：`PatternExtractor`（十進位鍵，AB-only）
- 改：`RecipeRegistry`（補 2L Echo：111/112/121/211/212/221；查詢介面）
- 改：`RecallPanel`（Check→列候選→預覽→Confirm 送選中 recipeId）

---

## 🧭 下一步（v0.6 前置）
- Provider 介面化：未來掛上 **unlock/gating/cooldown** 不動 UI。
- 若規模擴大，再評估 `ItemList` → `OptionButton/Popup`。

_備註：今日主要專注在 Issue #15 的最小閉環，已可在實機流程中穩定使用。_
