# Dev Log — 2025-09-24

> 多敵人 UI/交互與「死亡清理」流程落地；Phase 固定時機清屍，UI 槽位即時回收；未選目標時 UX 友善阻擋。

## 摘要 Highlights
- 建立 **EnemyContainer（6 槽位）** 與選取高亮機制，支援動態綁定/刷新/回收。
- **PhaseFunction** 新增 `PurgeDeadAndNotify`，在各 Phase 階段 **固定時機** 清除死亡敵人（資料層 `PurgeDeadEnemies`）與（預留）發送 UI 事件。
- **CombatState** 提供 `GetAliveEnemies`、`RemoveEnemyById`、`PurgeDeadEnemies` 純資料操作。
- **EchoPanel / Combat**：目標選取改走容器，缺目標時友善阻擋，不再使用魔術數字。
- **SignalHub** 精簡：保留 `OnEnemySlotClicked`，移除 `OnEnemySelected`，由容器內部統一處理選取。

---

## 變更總覽（from diff）
9 files changed, 295 insertions(+), 52 deletions(-)

recall_GODOT/Combat.cs | 47 +++++----
recall_GODOT/Combat.tscn | 22 ++---
recall_GODOT/Core/CombatState.cs | 23 ++++-
recall_GODOT/Core/Kernel/PhaseFunction.cs | 32 +++++-
recall_GODOT/Core/UI/SignalHub.cs | 5 +-
recall_GODOT/EnemyContainer.cs | 158 +++++++++++++++++++++++++++---
recall_GODOT/UIScript/EchoPanel.cs | 20 +++-
recall_GODOT/UIScript/EnemySlot.cs | 38 ++++++-
recall_GODOT/UIScript/EnemyView.cs | 2 +

---

## 詳細內容

### Core / Flow
- **CombatState**
  - 新增：`GetAliveEnemies()`，供 AI/選取/UI 取得活體清單。
  - 新增：`RemoveEnemyById(int)`、`PurgeDeadEnemies()`；**純資料操作、不發事件**。
  - 測試數值微調：第二隻初始 HP=3（便於驗證死亡回收路徑）。

- **PhaseFunction**
  - 於以下階段，**在判斷戰鬥結束前**插入 `PurgeDeadAndNotify(state)`：
    - `HandlePlayerExecution`
    - `HandleEnemyMarkExecution`
    - `HandleEnemyAction`
    - `HandleTurnEnd`（保險再清一次）
  - `CheckCombatEnd` 維持純判斷語意；清理與通知由固定位置處理。
  - 新增：`PurgeDeadAndNotify` 高階函式（目前已接資料清理；UI 事件留 TODO）。

### UI / 交互
- **EnemyContainer**
  - 建立 6 槽位佈局與初始化檢查；在 `_ExitTree()` 解除事件訂閱避免重複回呼。
  - `BindEnemyToSlot / RefreshSlot / RefreshUI`：
    - **敵人為 null 或死亡** → 立刻 `Unbind()`，避免 HP=0 殘留。
    - 相同 Id 僅刷新數值；Id 變動才 Rebind。
  - `OnSlotClicked` 維護 `selectedSlotIndex`，`UpdateSelection()` 高亮同步。
  - `GetDefaultTargetId(enemies)`：優先選中目標；否則**自動選第一個活著的**並同步高亮；若無則回傳 `null`。

- **EnemySlot**
  - `Unbind()`：清空所有 Label（含 Intent）、`EnemyId=null`、`Disabled=true`、`Visible=false`、`SetSelected(false)`、`ReleaseFocus()`。
  - `SetSelected(bool)`：用 Modulate 高亮（可後續換 Theme）。

- **EchoPanel**
  - 目標決策改為向 `Combat.GetDefaultTargetId()` 查詢。
  - 若技能需要 `Target` 且無有效目標 → `ShowReason("請選取目標")`，阻擋出手。

- **Combat**
  - 新增 `EnemyContainer` 匯出欄位；統一由容器處理選取與預設目標。
  - `TryRunAct`：未指定目標時委派取得；若仍無 → `ErrorLabel.ShowError(FailCode.BadTarget)` 並返回。
  - 移除舊版雙 `EnemyView` 硬綁；Refresh 改餵容器。

- **Scene**
  - `Combat.tscn` 加入 `EnemyContainer`，舊 `EnemyView` 隱藏。

- **SignalHub**
  - 保留：`OnEnemySlotClicked` 與 `NotifyEnemySlotClicked(...)`。
  - 移除：`OnEnemySelected`（由容器處理選取，不再跨層廣播選中 Id）。

---

## 行為改變（Breaking/Behavioral Changes）
- 技能若要求單體目標，且無選中或戰場無活敵 → **不再默默打向 #1**，改為錯誤提示。
- 敌人死亡後，**同 Phase 的固定時機** 即剔除名冊並（預留）通知 UI；不會再出現 HP=0 殘留槽位。
- 目標預設行為：優先使用選中槽；無選取時自動鎖定第一個活敵，並同步高亮。

---

## 驗收建議（手測腳本）
1. **死亡即時清槽**
   - 操作：把任一敵人打至 0 HP。
   - 預期：當前 Phase 內（隊列結束後）槽位隱藏，高亮回復；之後不再被選作目標。

2. **未選目標阻擋**
   - 操作：讓戰場只剩最後一隻敵人死亡，嘗試使用需要 Target 的技能。
   - 預期：不出手，顯示「請選取目標」或 `BadTarget`。

3. **自動選取**
   - 操作：未選中任何槽位直接使用單體技能。
   - 預期：會命中第一個活著的敵人，並將該槽位高亮。

4. **重複生成/回收**
   - 操作：多輪生成→擊殺→生成。
   - 預期：不殘留舊 Intent/HP/高亮；事件不重複觸發。

---

## 待辦 / 下一步
- [ ] `SignalHub.NotifyEnemyIntentCleared/NotifyEnemyRemoved` 在 `PurgeDeadAndNotify` 內去除 TODO，接上實際 UI 路徑。
- [ ] `EnemySlot.BindActor` 強化條件：**死亡或 null 視為 Unbind**（避免誤顯示 0HP）。
- [ ] 統一「多段 Intent」顯示管線（`EnemyIntentUpdated(enemyId, items)` → 容器路由 → 槽位多行渲染）。
- [ ] `CheckCombatEnd` 可用 `GetAliveEnemies().Count == 0` 精簡。
- [ ] 視覺：將選取高亮改為 Theme/StyleBox，避免與 Disabled/Hidden 狀態衝突。

---