V0.5.x Â· Intent Queue & Delayed Flow Stabilization

TL;DR

âœ… PlayerIntentQueueï¼šç©å®¶è¡Œç‚ºçµ±ä¸€é€²ä½‡åˆ—ï¼Œç”± PlayerExecute ä¸€æ¬¡æ¸…ç©ºã€‚

âœ… EnemyDelayedQueueï¼šæ•µæ–¹å»¶é²ï¼ˆç›®å‰ Aï¼‰æ”¹ç‚ºåœ¨ End Turn å¾Œæ–¼ EnemyExecDelayed åŸ·è¡Œã€‚

âœ… æ•µäººä¸ä½¿ç”¨ APï¼šAP è¦å‰‡åªå°ç©å®¶ç”Ÿæ•ˆï¼ˆç§»é™¤æ•µæ–¹ NoAP å•é¡Œï¼‰ã€‚

âœ… æ™‚æ©Ÿç­–ç•¥ï¼šA â†’ Delayedã€B/C â†’ Instantï¼›ç„¡ Instant æ™‚ç›´æ¥äº¤é‚„ç©å®¶ã€‚

âœ… æŸ¥æ‰¾ä»‹é¢æ›´æ–°ï¼šæ”¹ç”¨ TryGetActorById(int id, out Actor actor) å§”æ´¾è²«ç©¿ Translatorï¼Pipelineã€‚

è®Šæ›´æ‘˜è¦
1) ä½‡åˆ—åŒ–

PlayerIntentQueue

æ‰€æœ‰ç©å®¶ Basic / Recall å…ˆ enqueueï¼Œåœ¨ PlayerExecute æ‰¹æ¬¡ç¿»è­¯â†’åŸ·è¡Œã€‚

AP æ”¤æèˆ‡æ‰£æ¬¾æ”¹ç”±æ‰¹æ¬¡åŸ·è¡Œçµ±ä¸€è™•ç†ï¼Œé¿å…é€æ¢é€šéä½†ç¸½é‡ä¸è¶³çš„é‚Šç·£æƒ…æ³ã€‚

EnemyDelayedQueue

æ•µæ–¹ A æ”»æ“ŠæŒ‰ç­–ç•¥æ’å…¥ã€Œå»¶é²ä½‡åˆ—ã€ï¼ˆæœ¬å›åˆåˆ°æœŸæˆ–è·¨å›åˆï¼‰ã€‚

TryEndPlayerTurn æª¢æŸ¥åˆ°æœŸé …ï¼Œè½‰å…¥ EnemyExecDelayed é€ç­†åŸ·è¡Œï¼›å¦å‰‡ç›´æ¥ TurnEndã€‚

2) AP è¦å‰‡ï¼ˆç©å®¶å°ˆå±¬ï¼‰

æ•µäººä¸æŒæœ‰ï¼ä¸æ¶ˆè€— APï¼›åªå°ç©å®¶åš AP æˆæœ¬æª¢æŸ¥èˆ‡ ConsumeAP æŒ‡ä»¤ç”¢ç”Ÿã€‚

å»ºæŒ‡ä»¤æ™‚åƒ…åœ¨ APCost > 0 æ‰åŠ å…¥ ConsumeAPï¼Œé™ä½æ—¥èªŒå™ªéŸ³ã€‚

3) Phase æ˜ å°„èª¿æ•´

EnemyIntentï¼šåªåœ¨æœ¬å›åˆç”¢ç”Ÿä¸€æ¬¡æ„åœ–ä¸¦å…¥åˆ—ã€‚

è‹¥æœ‰ Instant â†’ EnemyExecInstant

è‹¥ç„¡ Instant â†’ PlayerInitï¼ˆäº¤é‚„ç©å®¶ï¼‰

EnemyExecInstantï¼šæ¸…ç©ºå¾Œå›ºå®š â†’ PlayerInit

TryEndPlayerTurnï¼šæœ‰ due çš„ Delayed â†’ EnemyExecDelayedï¼›å¦å‰‡ TurnEnd

EnemyExecDelayedï¼šåªæ¶ˆè²»ã€Œæœ¬å›åˆåˆ°æœŸã€ï¼ŒåŸ·è¡Œå®Œå›ºå®š â†’ TurnEnd

4) Translator/ä»‹é¢

ä½¿ç”¨å§”æ´¾ TryGetActorById å–ç›®æ¨™èˆ‡è­˜åˆ¥ç©å®¶ï¼Œè®“ã€Œæ˜¯å¦åƒ APã€åœ¨ Translator ç«¯å¯åˆ¤æ–·è€Œä¸ç¶å®šå…·é«”å‹åˆ¥ã€‚

é©—æ”¶èˆ‡è§€å¯Ÿ

ğŸŸ¢ B â†’ EndTurn â†’ A(Delayed,0)ï¼šåŒå›åˆç›¾å…ˆåˆ°ä½ï¼Œå»¶é² A æ­£ç¢ºè¢«ç›¾å¸æ”¶ï¼Œæ—¥èªŒé¡¯ç¤º shield absorbed N, HP damage Mã€‚

ğŸŸ¢ åƒ… Aï¼ˆDelayedï¼‰ï¼šEnemyIntent â†’ PlayerInit/Draw/Input â†’ â€¦ â†’ EndTurn â†’ EnemyExecDelayed(A) â†’ TurnEndï¼Œä¸å†åœ¨ EnemyIntent â†” EnemyExecInstant é–“æ‰“è½‰ã€‚

ğŸŸ¢ NoAP ç§»é™¤ï¼šå»¶é²æ”»æ“Šä¸å†å›  AP åˆ¤æ–·è¢«ä¸Ÿæ£„ã€‚

ğŸŸ¡ æ—¥èªŒï¼šè‹¥å‚·å®³å…¨è¢«æ ¼æ“‹ï¼Œå¯èƒ½åªçœ‹åˆ°ã€Œå¸æ”¶ Nã€ï¼Œå»ºè­°æ°¸ä¹…å°å‡º HP damage 0ï¼ˆå·²åˆ—åœ¨ TODOï¼‰ã€‚

ä¿®å¾©çš„å•é¡Œ

ğŸ”§ æ•µäºº AP å°è‡´å»¶é²æ”»æ“Šå¤±æ•ˆï¼šæ•µæ–¹æŒ‡ä»¤ä¸å†ç”¢ç”Ÿ ConsumeAPï¼›NoAP ä¸æœƒå†ä¸­æ–·å»¶é²æ”»æ“Šã€‚

ğŸ”§ PhaseRunner è¿­ä»£ timeoutï¼šä¿®æ­£ EnemyExecInstant ç©ºä½‡åˆ—æ™‚èª¤å› EnemyIntent çš„è·¯å¾‘ï¼›ç¾åœ¨æ”¹ç‚ºäº¤é‚„ PlayerInitã€‚

å¾…è¾¦ / é¢¨éšª

 Delayed åˆ°æœŸèªæ„å›ºå®šï¼š
é¸æ“‡ ç›¸å°å›åˆï¼ˆdue-- æ¶ˆè²» 0ï¼‰ æˆ– çµ•å°å›åˆï¼ˆdueAtTurn==currentTurnï¼‰ï¼Œçµ±ä¸€å…¨åŸŸä½¿ç”¨ã€‚

 EnemyIntent å–®æ¬¡ç”¢ç”Ÿï¼šä»¥æ——æ¨™ä¿è­‰åŒå›åˆä¸é‡å…¥ï¼Œå›åˆèµ·é»é‡ç½®ã€‚

 Damage æ—¥èªŒä¸€è‡´æ€§ï¼š0 å‚·ä¹Ÿå° DealDamage ... HP damage 0ï¼Œæå‡å¯è§€æ¸¬æ€§ã€‚

 æ•´åˆæ¸¬è©¦ï¼šæ–°å¢ä¸‰æ¢ E2E é©—è­‰

Only A(Delayed,0)

B(Instant)+A(Delayed,0)

A(Delayed,1)ï¼ˆè·¨å›åˆï¼‰

 UI ç´°ç¯€ï¼šç•¶ HasPendingIntent æˆ–æœ‰åˆ°æœŸ Delayed æœªè™•ç†æ™‚ï¼ŒEnd Turn æŒ‰éˆ•ç‹€æ…‹èˆ‡æç¤ºä¸€è‡´ã€‚