ğŸ› ï¸ Dev Log â€” 2025-09-20

ç¯„åœï¼šCore + Pipeline + Translator + Godot UI
çµ±è¨ˆï¼š7 files changed, 200 insertions, 108 deletions

TL;DR

å¤šæ•µäººåŸºç¤å®Œæˆï¼šActor.Idã€CombatState.GetAllEnemies()ã€TryGetActorByIdã€UI ç¶å®šå…©å€‹ EnemyViewï¼Œæ„åœ–æ›´æ–°/æ¸…é™¤æ”¹ç‚ºä¾ enemyId åˆ†ç™¼ã€‚

Pipeline å®‰å…¨æ€§ï¼šæ•µæ–¹éšŠåˆ—åœ¨åŸ·è¡Œå‰ç•¥éæ­»äº¡æ•µäººï¼Œä¸¦åƒ…æ¸…ç©ºè¢«è™•ç†ä¹‹æ•µäººçš„æ„åœ–ã€‚

Translator ç›®æ¨™æª¢æŸ¥ï¼šTargetType.Target åƒ…æ¥å—å­˜æ´»ä¸”éè‡ªèº«çš„ç›®æ¨™ï¼Œé¿å…é»æ­»é«”ã€‚

æˆ°é¬¥çµæŸæ¢ä»¶ï¼šç©å®¶æ­»äº¡æˆ–æ‰€æœ‰æ•µäººéƒ½æ­»äº¡å³çµæŸï¼ˆä¸å†åªçœ‹å–®ä¸€ Enemyï¼‰ã€‚

æª”æ¡ˆçµæ§‹æ¸…ç†ï¼šIntent èˆ‡ RecallView å¾ Translator.cs ç§»åˆ° Utils.csï¼Œé™ä½è€¦åˆã€‚

è®Šæ›´é‡é»ï¼ˆä¾æ¨¡çµ„ï¼‰
Godot / UI

Combat.cs

æ–°å¢ EnemyView2 åŒ¯å‡ºèˆ‡ _enemyViews: Dictionary<int, EnemyView> æ˜ å°„ã€‚

BindActorsToUI() æ”¯æ´å…©å€‹æ•µäººï¼›InitializeEnemyViews() å»ºç«‹ ActorId â†’ View å°è¡¨ã€‚

UpdateEnemyIntent(enemyId, items) / ClearEnemyIntent(enemyId) ä¾æ˜ å°„æ›´æ–°/æ¸…é™¤å°æ‡‰æ•µäººçš„ UIã€‚

RefreshAllUI() æœƒåˆ·æ–° EnemyView2ã€‚

çµæœï¼šå¤šæ•µäººæ™‚ï¼Œæ„åœ–åœ–ç¤ºèˆ‡æ–‡å­—èƒ½å„è‡ªæ›´æ–°ã€å„è‡ªæ¸…ç©ºã€‚

Core / Actor & State

Actor.cs

æ–°å¢ Id æ¬„ä½ï¼ˆé è¨­ -1ï¼‰ï¼›ç¶­æŒæ—¢æœ‰å…ƒä»¶ï¼ˆHP/Shield/AP/Copyï¼‰ã€‚

CombatState.cs

æ”¹ç‚ºå…§éƒ¨ç®¡ç† _enemies: List<Actor> èˆ‡ _actorById: Dictionary<int, Actor>ã€‚

å…§è¨­ç¤ºä¾‹ï¼šenemy1.Id=1ã€enemy2.Id=2ï¼›æä¾› GetAllEnemies() èˆ‡ TryGetActorById()ã€‚

Enemy å±¬æ€§å‘å¾Œç›¸å®¹ï¼ˆå›å‚³ç¬¬ä¸€å€‹æ•µäººï¼Œè‹¥ä¸å­˜åœ¨å‰‡æ“²ä¾‹å¤–ï¼‰ã€‚

InterOp / Translator & Utils

Translator.cs

ç§»é™¤ Intent/RecallView å‹åˆ¥å®£å‘Šï¼ˆä¸‹ç§»åˆ° Utils.csï¼‰ã€‚

ç›®æ¨™è§£æï¼šTargetType.Target éœ€ tryGetActor(...) && !ReferenceEquals(actor,self) && actor.IsAlive æ‰æˆç«‹ã€‚

Utils.cs

æ–°å¢ï¼ˆæˆ–æ•´ä½µï¼‰ï¼š

public abstract record Intent(int? TargetId)

public sealed record RecallIntent(int RecipeId) : Intent(null)

public sealed record ActIntent(Act Act, int? TargetId) : Intent(TargetId)

public readonly struct RecallView(...)ï¼ˆåŸä¾†å¾ Translator æ‹†å‡ºï¼‰

å‘½åç©ºé–“å°é½Šï¼šä¾› Translator/Pipeline å…±ç”¨ã€‚

Kernel / Pipeline & Phase

CombatPipeline.cs

ProcessEnemyMarkQueue() / ProcessEnemyActionQueue()ï¼š

è·³éæ­»äº¡æ•µäººçš„æ’ç¨‹ã€‚

è’é›†æœ¬æ‰¹æœ‰åŸ·è¡Œçš„ enemyId â†’ é€ä¸€å‘¼å« SignalHub.NotifyEnemyIntentCleared(enemyId)ï¼ˆä¸å†ç¡¬å¯« 1ï¼‰ã€‚

GenerateAndEnqueueEnemyActions()ï¼ˆç°¡æ˜“ AI ç¯„ä¾‹ï¼‰ï¼š

Enemy1ï¼ˆId=1ï¼‰ï¼šå¥‡æ•¸å›åˆå®£å‘Š Blockï¼ˆInstant/Markï¼‰ï¼›å¶æ•¸å›åˆå®£å‘Š Attackï¼ˆDelayedï¼‰ã€‚

Enemy2ï¼ˆId=2ï¼‰ï¼šæ¯å›åˆå®£å‘Š Blockï¼ˆInstant/Markï¼‰ã€‚

å®£å‘Šæ™‚å³ä»¥ SignalHub.NotifyEnemyIntentUpdated(enemy.Id, items) ç™¼é€ UI é å‘Šã€‚

CreateEnemyBasicAct(HLAop op)ï¼šç§»é™¤ PushMemoryï¼›ï¼ˆèˆ‡ Canon ä¸€è‡´ï¼šæ•µè¡Œç‚ºä¸å¯«å…¥ç©å®¶è¨˜æ†¶ï¼‰

PhaseFunction.cs

CheckCombatEnd(...)ï¼šç©å®¶æ­»äº¡æˆ–æ‰€æœ‰æ•µæ–¹çš†æ­»äº¡ â†’ CombatEndã€‚

è¡Œç‚ºé©—æ”¶ï¼ˆæ‰‹å‹•ï¼‰

å…©æ•µ UIï¼šå›åˆé–‹å§‹å¯è¦‹ Enemy1ï¼šğŸ›¡Block / Enemy2ï¼šğŸ›¡Defendï¼›ä¸‹å›åˆåˆ‡æ›æ™‚ï¼Œå„è‡ªçš„æ„åœ–æœƒè¦†è“‹æˆ–æ¸…ç©ºï¼Œè¦–ä½‡åˆ—åŸ·è¡Œæƒ…æ³è€Œå®šã€‚

æ­»é«”è™•ç†ï¼šæ“Šæ®ºä»»ä¸€æ•µäººå¾Œï¼Œå…¶å¾ŒçºŒå›åˆä¸å†åŸ·è¡Œä½‡åˆ—ï¼Œä¸”è©²æ•µæ„åœ–æœƒè¢«æ¸…ç©ºï¼Œä¸å½±éŸ¿å¦ä¸€åæ•µäººã€‚

ç›®æ¨™åˆæ³•æ€§ï¼šå˜—è©¦å°æ­»äº¡æ•µäººä¸‹é” Target è¡Œç‚º â†’ Translator é˜»æ“‹ï¼ˆBadTarget é¡ï¼‰ï¼Œä¸æœƒç”¢ç”Ÿå‘½ä»¤ã€‚

èˆ‡ Canon å°é½Š

Only Basic æ¨å…¥è¨˜æ†¶ï¼šæ•µæ–¹ Act å–æ¶ˆ PushMemoryï¼Œç¬¦åˆã€ŠGAMEPLAY_CANON.mdã€‹ã€‚

æ•µäººä¸ä½¿ç”¨ APï¼šæœ¬æ¬¡æ”¹å‹•æœªå¼•å…¥æ•µæ–¹ APï¼›ä¾èˆŠåƒ…ç©å®¶æœ‰ APã€‚

å³æ™‚/å»¶é²ï¼šç¯„ä¾‹ç­–ç•¥ç¶­æŒ B/C â†’ Instantã€A â†’ Delayed çš„é è¨­ç¯€å¥ã€‚

å¾…è¾¦ / é¢¨éšª

UI ç¶å®šæ•¸é‡ï¼šç›®å‰æ¨£ä¾‹åƒ…å…©å€‹ EnemyViewï¼›å»ºè­°å¾ŒçºŒæ”¹ç‚ºå‹•æ…‹å®¹å™¨ï¼ˆä¾ GetAllEnemies() è‡ªå‹•ç”Ÿæˆæ§½ä½ï¼‰ã€‚

Id ä¸€è‡´æ€§ï¼šéœ€åœ¨æˆ°é¬¥åˆå§‹åŒ–éšæ®µçµ±ä¸€é…ç½® Actor.Idï¼ˆæœªä¾†è‹¥æœ‰è¼‰å…¥/å­˜æª”ï¼Œè«‹åŒæ­¥æŒä¹…åŒ–ï¼‰ã€‚

Target é¸æ“‡å™¨ï¼šç©å®¶å´ UI ä»å‡å®šå–®ä¸€æ•µäººï¼›å¾ŒçºŒéœ€æä¾›æ˜ç¢ºé¸æ“‡ç›®æ¨™çš„äº¤äº’ã€‚

å–®å…ƒæ¸¬è©¦ï¼šæ–°å¢

Pipeline_SkipDeadEnemyIntents_And_ClearById

Translator_TargetTypeTarget_RejectsDeadOrSelf

Phase_EndWhenAllEnemiesDead

è³‡æ–™é©…å‹• AIï¼šç›®å‰ç‚ºç¡¬ç·¨æ’ç¤ºä¾‹ï¼›å»ºè­°æ”¹ç‚ºè³‡æ–™è¡¨/ç­–ç•¥å‡½å¼ä¾¿æ–¼æ“´å……ã€‚

è®Šæ›´æª”æ¡ˆ

recall_GODOT/Combat.csï¼ˆå¤šæ•µ UI ç¶å®šã€æ„åœ–åˆ†ç™¼èˆ‡æ¸…ç†ï¼‰

recall_GODOT/Core/ActorOp/Actor.csï¼ˆæ–°å¢ Idï¼‰

recall_GODOT/Core/CombatState.csï¼ˆå¤šæ•µæ¸…å–®èˆ‡ TryGetActorByIdï¼‰

recall_GODOT/Core/InterOp/Translator.csï¼ˆç›®æ¨™æª¢æŸ¥å¼·åŒ–ã€å‹åˆ¥ç²¾ç°¡ï¼‰

recall_GODOT/Core/InterOp/Utils.csï¼ˆIntent/RecallView ç§»å…¥ï¼‰

recall_GODOT/Core/Kernel/CombatPipeline.csï¼ˆéšŠåˆ—è™•ç†å¥å…¨åŒ–ã€AI ç¯„ä¾‹ã€é€æ•µæ¸…ç†æ„åœ–ï¼‰

recall_GODOT/Core/Kernel/PhaseFunction.csï¼ˆæˆ°é¬¥çµæŸæ¢ä»¶æ”¹ç‚ºã€Œå…¨æ»…ã€ï¼‰