# Dev Log — 2025-09-11

## TL;DR
- 「Basic 動作」全面改為 **Echo Slots** 驅動；UI 按鈕以 Echo ID 觸發。
- 新增 **Echo 冷卻系統**（`CooldownTurns` + `CooldownCounter`），回合開始自動遞減，UI 顯示剩餘回合並禁用點擊。
- Intent/Translator/AI 全面切換到 `EchoIntent`；移除 `BasicIntent` 路徑。
- 將 AB(C) 操作枚舉自 `ActionType` 正名為 **`TokenType`**，波及 Memory/Pattern/RecallView 等資料面。
- **敵方時序對齊 & 事件簡化**：即時/延遲重命名為 **Mark / Action**；隊列與 Phase 重整；UI 改用 `Updated/Cleared` 兩事件顯示與清除意圖。

---

## Gameplay / 系統

### Basic as Echo
- **Basic 三鍵改為 Echo Slots（ID: 101/102/103）**：A=Attack、B=Block、C=Copy/Charge；每個 Slot 具備 `PushMemory`、`CooldownTurns`、`CostAP` 等設定，隨用隨管理。
- **Combat UI 不再走 `TryRunBasic(ActionType, target)`**；移除舊事件，改以 `TryRunBasicSlot(echoId, targetId)` 查 Slot 後派送 `EchoIntent`。

### Echo 冷卻
- **資料結構**：新增 `CooldownTurns`（靜態配置）與 `CooldownCounter`（動態狀態），並提供 `IsReady`。
- **觸發與遞減**：Echo 成功使用後將 `CooldownCounter = CooldownTurns`；在 **回合開始**統一 `--`。
- **UI 呈現**：冷卻中按鈕顯示 `Name (N)`、禁用並以紅色淡化；可用時恢復。選擇成功清空錯誤訊息。
- **錯誤碼**：新增 `FailCode.EchoCooldown`，UI 文案「Echo冷卻中」。

### Intent / Translator / AI
- **移除 BasicIntent**：Translator 的 Basic 分支整段刪除，Echo 轉譯流程改直出 BasicPlan。目標驗證/扣 AP/冷卻判斷集中在 `TranslateEchoIntentInternal`。
- **AI 時機判定** 改看 Echo 的 `HLAop`：`Attack → Action`、`Block/Charge → Mark`（原本 Instant/Delayed 正名）。
- **敵行為產生**：以 `CreateEnemyBasicEcho(HLAop, TokenType)` 建立對應 Echo，再包 `EchoIntent` 送入隊列（`Mark` 或 `Action`）。敵人不耗 AP。
- **（暫值）數值**：`Attack=2`、`Block=1`、`Charge=+2` 已於 Echo→Plan 映射使用（僅用於本日驗證）。

### Pipeline / 記憶寫入
- **Commit 階段**：Echo 成功→觸發冷卻；若標記 `ActionFlags.Basic` 且具 `PushMemory`，則將對應 Token 推入 Memory；若 `ConsumeOnPlay`，自動移除該 Echo。取代原本「Echo 一律移除且不寫 Memory」的行為。

### 敵方時序與隊列（已完成）
- **Phase 更名與路由**：  
  - `EnemyExecInstant/EnemyExecDelayed` → **`EnemyExecMark/EnemyExec`**。  
  - `PhaseMap` 調整為：`EnemyInit → EnemyExecMark → EnemyIntent → PlayerInit … → EnemyExec → TurnEnd`。
- **Queue 更名**：  
  - `EnemyInstantQueue` → **`EnemyMarkQueue`**（回合開始結算的標記類行為，如 Block）。  
  - `EnemyDelayedQueue` → **`EnemyActionQueue`**（本回合結束結算的行為，如 Attack/Debuff/Buff）。
- **執行點**：  
  - `ProcessEnemyMarkQueue()`：回合開始時結算標記；結束後發出 **Cleared**（見下節）。  
  - `ProcessEnemyActionQueue()`：回合末結算行動；結束後發出 **Cleared**。

---

## 資料面 / 類型更名

- **ActionType → TokenType**：  
  - Enum 正名與註解更新（A/B/C 表意為記憶 Token）。  
  - **RecallView** 內部 Ops 型別改為 `IReadOnlyList<TokenType>`。  
  - **MemoryQueue** 儲存/快照全面改用 `TokenType`。  
  - **PatternExtractor** 的 `Encode/ActionToDigit` 改接 `TokenType`。

---

## UI

### Echo / 基本操作
- **EchoPanel**：按鈕渲染加入冷卻分支，並在點擊選取時進一步攔截「冷卻中」。
- **BasicMoveUI**：將三鍵改為透過 Echo ID 解析並呼叫 `TryRunEcho`。
- **Scene 調整**：  
  - `BasicMoveUI.tscn`：暫時隱藏 `HBoxContainer`（`visible=false`）。  
  - `RecallPanel.tscn`：Info 區 `layout_mode = 0`（避免排版異常）。

### 敵方意圖（Intent）顯示（已完成）
- **SignalHub 事件（簡化版）**：  
  - `OnEnemyIntentUpdated(int enemyId, IReadOnlyList<EnemyIntentUIItem> items)`  
  - `OnEnemyIntentCleared(int enemyId)`  
  （取消 dueTag；**Queue 自行決定時機**，宣告時推 `Updated`，結算後推 `Cleared`。）
- **Combat 訂閱**：`UpdateEnemyIntent` / `ClearEnemyIntent` 綁定到 `EnemyView`。  
- **EnemyView**：新增 `IntentLabel` 與 `UpdateIntent(icon, text)`、`ClearIntent()`；實測顯示如：`Enemy Declare : Attack 2`。  
- **隊列對接**：`ProcessEnemyMarkQueue` / `ProcessEnemyActionQueue` 階段完成後分別呼叫 `NotifyEnemyIntentCleared(enemyId)` 清空 UI。

---

## 既知風險 / 注意事項
- **冷卻 tick 時機**：目前在 **回合開始**遞減；若未來有「回合結束」或「跳過多回合」機制，需再次檢視與 UI 顯示一致性（避免 ±1）。
- **數值來源**：Basic Echo 目前以常數（`A=2,B=1,C=+2`）直寫於映射，用於本日驗證；後續應集中到數值計算處/Recipe 資料來源，避免重複。
- **回溯相容**：`TokenType` 更名已覆蓋 Memory/Pattern/RecallView/InterOps；若有其它反射/序列化資料，需清點。
- **多敵準備**：目前清除事件仍以單敵流程為主；`actorId` 對映與多敵 `EnemyView` 映射，將放入後續 refine。

---

## 待辦（Next）
1. **Cooldown Provider 化**：將 `CooldownTurns/CooldownCounter` 外移到 Provider（支援群組共享、可充能、多段回充）。  
2. **數值表一元化**：建立 Basic/Echo 共用的數值來源（含 AP、Copy/Charge 交互）。  
3. **UI/UX**：Slot 顯示進一步區分類型（Basic vs Echo）、加入 Tooltip，冷卻動態效果。  
4. **測試**：  
   - Echo 冷卻邏輯（使用→回合流→再次可用）。  
   - AI EchoIntent 的 `Mark/Action` 觸發順序。  
   - Memory Push 僅於 `Basic` 標記的 Echo 生效。  
5. **refine: 導入 `Actor.Id`（戰鬥內唯一）**：CombatState 統一指派；事件以 `actorId` 對應 UI（支援多敵）。  
6. **refine: 事件節流**：相同 `items` 不重刷，避免標籤閃爍。

---
